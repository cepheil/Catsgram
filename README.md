# Catsgram

REST API сервис для публикации фотографий котов — аналог Instagram для котиков.

Пользователи могут регистрироваться, создавать посты с описаниями и прикреплять к ним изображения.

## Стек технологий

- **Java 21**
- **Spring Boot 3.2** (Spring MVC, Spring JDBC)
- **PostgreSQL 16** — реляционная БД
- **JDBC + JdbcTemplate** — работа с базой данных без ORM
- **Docker / Docker Compose** — контейнеризация и развёртывание
- **Lombok** — сокращение boilerplate-кода
- **Maven** — сборка проекта
- **Checkstyle** — контроль стиля кода

## Архитектура

Трёхслойная архитектура с разделением ответственности:

```
Controller  →  Service  →  Repository (DAL)
    ↕              ↕              ↕
   DTO          Model         JDBC / SQL
```

- **Controller** — обработка HTTP-запросов, валидация параметров, маппинг DTO
- **Service** — бизнес-логика, проверки, координация между сервисами
- **DAL (Data Access Layer)** — слой доступа к данным на чистом JDBC через обобщённый `BaseRepository<T>` с методами `findOne`, `findMany`, `insert`, `update`, `delete`

Дополнительно:
- **DTO + Mapper** — разделение транспортных и доменных моделей
- **Централизованная обработка ошибок** — `@RestControllerAdvice` с маппингом исключений на HTTP-статусы (404, 409, 422, 400, 500)
- **Загрузка изображений** — сохранение файлов на диск с метаданными в БД

## Схема базы данных

```
┌──────────────┐       ┌──────────────┐       ┌────────────────┐
│    users     │       │    posts     │       │ image_storage  │
├──────────────┤       ├──────────────┤       ├────────────────┤
│ id (PK)      │◄──────│ author_id(FK)│       │ id (PK)        │
│ username     │       │ id (PK)      │◄──────│ post_id (FK)   │
│ email        │       │ description  │       │ original_name  │
│ password     │       │ post_date    │       │ file_path      │
│ reg_date     │       └──────────────┘       └────────────────┘
└──────────────┘
```

## API эндпоинты

### Users

| Метод  | Эндпоинт        | Описание                  | Статус |
|--------|------------------|---------------------------|--------|
| POST   | `/users`         | Создать пользователя      | 201    |
| PUT    | `/users/{id}`    | Обновить пользователя     | 200    |
| GET    | `/users`         | Получить всех пользователей | 200  |
| GET    | `/users/{id}`    | Получить пользователя по ID | 200  |

### Posts

| Метод  | Эндпоинт              | Описание                           | Статус |
|--------|------------------------|------------------------------------|--------|
| POST   | `/posts`               | Создать пост                       | 201    |
| PUT    | `/posts/{id}`          | Обновить пост                      | 200    |
| GET    | `/posts`               | Получить все посты                 | 200    |
| GET    | `/posts/{id}`          | Получить пост по ID                | 200    |
| GET    | `/posts/by-author?authorId=` | Получить посты автора        | 200    |

### Images

| Метод  | Эндпоинт                     | Описание                     | Статус |
|--------|-------------------------------|------------------------------|--------|
| POST   | `/posts/{postId}/images`      | Загрузить изображения к посту | 201    |
| GET    | `/posts/{postId}/images`      | Получить изображения поста    | 200    |
| GET    | `/images/{imageId}`           | Скачать изображение           | 200    |

## Запуск

### Предварительные требования

- Java 21+
- Maven 3.8+
- Docker и Docker Compose

### 1. Запуск базы данных

```bash
docker compose up db db-init -d
```

Контейнер `db-init` автоматически создаст таблицы при первом запуске.

### 2. Сборка и запуск приложения

```bash
mvn package
java -jar target/Catsgram-1.0-SNAPSHOT.jar
```

Или через Maven:

```bash
mvn spring-boot:run
```

Приложение будет доступно по адресу: `http://localhost:8080`

### Docker-образ

```bash
mvn package
docker build -t catsgram .
docker run -p 8080:8080 catsgram
```

Dockerfile использует multi-stage сборку с layered JARs для оптимизации размера образа.
